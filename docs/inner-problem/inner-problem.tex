\documentclass[american, abstract=on]{scrartcl}

    \newcommand{\lang}{en}

    \usepackage{babel}
    \usepackage[utf8]{inputenc}

    \usepackage{csquotes}

    \usepackage{amsmath, amssymb, mathtools, bbm}
    \usepackage{amsthm}
    \usepackage{xcolor}
    \usepackage{xcolor-solarized}
    \usepackage{bm}

    \usepackage{graphicx}
    \usepackage{wrapfig}
    \usepackage{relsize}
    \usepackage{makecell}
    \usepackage{booktabs}
    \usepackage[font=footnotesize,labelfont=bf]{caption}
    \usepackage{subcaption}
    \usepackage{float}
    \usepackage{multirow} 
    \usepackage{hyperref}
    
    % Formatting
    \setlength{\parindent}{0em}
    \setlength{\parskip}{0.5em}
    \setlength{\fboxsep}{1em}
    \newcommand\headercell[1]{\smash[b]{\begin{tabular}[t]{@{}c@{}} #1 \end{tabular}}}

    % Theorems
    \theoremstyle{plain}
    \newtheorem{claim}{Claim}

    % Math commands

    \newcommand{\diff}{\text{d}}
    \renewcommand{\Re}{\mathbb{R}}
    \newcommand{\C}{\mathcal{C}}
    \newcommand{\F}{\mathcal{F}}
    \newcommand{\X}{\mathcal{X}}
    \newcommand{\G}{\mathcal{G}}
    \newcommand{\I}{\mathcal{I}}
    \newcommand{\N}{\mathcal{N}}
    \newcommand{\PF}{\mathcal{P} \F}

    \renewcommand{\P}{\mathbb{P}}
    \newcommand{\E}{\mathbb{E}}
    \newcommand{\V}{\mathbb{V}}

    \newcommand{\uI}[2][s]{\int^1_0 #2 \ \text{d} #1}
    \newcommand{\uH}[2][s]{\int^\frac{1}{2}_0 #2 \ \text{d} #1}
    \newcommand{\uF}[2][s]{\int^1_\frac{1}{2} #2 \ \text{d} #1}
    \newcommand{\norm}[1]{\left\lVert#1\right\rVert}
    \newcommand{\abs}[1]{\left\lvert#1\right\rvert}

    \newcommand{\Beta}{\text{Beta}}
    \newcommand{\Bin}{\text{Bin}}

    \DeclarePairedDelimiter{\floor}{\lfloor}{\rfloor}

    % Bibliography

    \usepackage[bibencoding=utf8, style=apa, backend=biber]{biblatex}
    \addbibresource{../supply-chain-reallocation.bib}
    \addbibresource{../math.bib}

    \newcommand{\citein}[1]{\citeauthor{#1} (\citeyear{#1})}

    % Make title page

    \author{Andrea Titton}
    \title{Derivation of mapping}

    \setcounter{section}{-1}  % Start numbering at 0
    
\begin{document}

\maketitle

\section{Notation}

\begin{enumerate}
    \item For some integer $m$, let $[m] \coloneqq \{0, 1, \ldots, m\}$.
    \item For two numbers $x, s$ let the falling factorial of $x$ to $s$ be \begin{equation}
        (x)_s \coloneqq \begin{cases} x(x - 1)(x - 2)\ldots(x - (s - 1)) & \text{if } s \in \mathbb{N}_0 \\
       \Gamma(1 + x) \Big/ \Gamma(1 + x - s)& \text{if } s \in \Re^{+}
        \end{cases}
    \end{equation} and the rising factorial of $x$ to $s$ be \begin{equation}
        x^{(s)} \coloneqq \begin{cases} x(x + 1)(x + 2)\ldots(x + (s - 1)) & \text{if } s \in \mathbb{N}_0 \\
            \Gamma(1 + x + s) \Big/ \Gamma(1 + x)& \text{if } s \in \Re^{+}
             \end{cases}.
    \end{equation} This notation is a bit contentious since the Pochhammer symbol $(x)_s$ has been used to denote rising factorials, falling factorials, and binomial coefficients. The notation I chose is used in the Combinatorics and Graph Theory literature (\cite{harris_combinatorics_2008}).
\end{enumerate}

\section{Problem statement}

Define $F \in [m]$ to be the number of functioning firm in the suppliers layer and assume 

\begin{equation}
    F \sim \Beta\Bin(m, 1 - \mu, \rho)
\end{equation}

with $m \in \mathbb{N}_0$ and $\mu, \rho \in [0, 1]$.

\subsection{Notes on the beta-binomial distribution}

\begin{enumerate}
    \item Usually, the beta-binomial is parametrized with two parameters $\alpha$ and $\beta$. Here I choose $f$ and $\rho$ instead, which provide a better interpretation for the problem at hand. The two parametrisations can be linked by taking \begin{equation}
        \rho = \frac{1}{\alpha + \beta + 1} \text{ and } \mu = \frac{\beta}{\alpha + \beta}.
    \end{equation}

    Other identities I will use extensively are

    \begin{equation}
        \alpha + \beta = \frac{1-\rho}{\rho} \text{ and } \beta = \mu \ \frac{1-\rho}{\rho}
    \end{equation}

    \item The beta-binomial can be seen as a compounded random variable, generated by taking a binomial distribution $F \sim \Bin(m, p)$ with probability of success $p \sim \Beta(\alpha, \beta)$.
    \item The first two moments of the beta-binomial distribution can be written as \begin{equation}
        \E[F] = m (1 - \mu) \text{ and } \V[F] = m \mu (1 - \mu) (1 + (m - 1) \rho).
    \end{equation} If $\rho = 0$, the beta-binomial degenerates into a binomial distribution, hence $\rho$ can be interpreted as an ``overdispersion'' vis-Ã -vis the binomial distribution.
    \item The probability mass function of the beta-binomial distribution is \begin{equation} \label{eq:pmf_betabinomial}
        f_F(k) = \binom{m}{k} \frac{B(k + \alpha, m - k + \beta)}{B(\alpha, \beta)}
    \end{equation} where $B$ is the beta function. 
    \item The moment generating function of the beta-binomial is \begin{equation} \label{eq:mgf_betabinomial}
        M_F(t) = \E\left[ e^{tF} \right] = \prescript{}{2}{F}_1(-m, \alpha, \alpha + \beta; 1 - e^{t}) = \sum^m_{n = 0} (-1)^n \binom{m}{n} \frac{B(\alpha + n, \beta)}{B(\alpha, \beta)} (1 - e^t)
    \end{equation}
\end{enumerate}

\subsection{The next layer probability}

Let $p_m$ be the function that maps the number of functioning firms in the suppliers layer and the number of chosen suppliers to the probability of a firm being functional in a given layer. In particular, $p_m: [0, m] \times \{0, 1, 2, \ldots m\} \to [0, 1]$ can be written equivalently

\begin{equation}
    p_m(s, F) = 1 - \binom{m - s}{F} \binom{m}{F}^{-1} = 1 - \frac{(m - F)_s}{(m)_s}
\end{equation}

\begin{claim}
    If $F \sim \Beta\Bin(m, 1 - \mu, \rho)$ then $\lim_{m \rightarrow \infty} p_m(s, F) = p(s, F) \sim \Beta(1 - \mu', \rho')$ for some $\mu'$ and $\rho'$.
\end{claim}

\begin{proof}
    
    To simplify things, consider $N_m \coloneqq m - F \sim \Beta\Bin(m, 1 - f, \rho)$. I will prove that $\lim_{m \rightarrow \infty} \big( 1 - p_m(s, N_m) \big) \sim \Beta(1 - f', \rho')$. We can write

    \begin{equation}
        1 - p_m(s, N_m) = \frac{N_m}{m} \frac{N_m - 1}{m - 1} \ldots \frac{N_m - (s + 1)}{m - (s + 1)}.        
    \end{equation}

    Below I show that \begin{equation}
        \lim_{m \rightarrow \infty} \frac{N_m}{m} \sim Beta(1 - f, \rho).
    \end{equation}


\end{proof}

I will approximate

\begin{equation}
    p(s, F) \ \dot{\sim} \ \Beta(\mu', \rho').
\end{equation}

Motivated by simulated results (see Figure \ref{fig:pfit}), I believe this to be not an approximation but the true distribution of $p(s, F)$.\footnote{Currently working on the proof using the moment generating function of $F$.}

\begin{figure}[H]
    \centering
    \includegraphics[width = 0.8\linewidth]{../plots/pfit.png}
    \caption{Cumulative density function of $p(s, F)$ (line) and the fitted $\Beta$ distribution (scatter).}
    \label{fig:pfit}
\end{figure}

We parametrised $p(s, F)$ with $(\mu', \rho')$, which have the same interpretation as in $F$. In particular,

\begin{equation}
    \E\big[p(s, F)\big] = 1 - \mu' \text{ and } \V\big[p(s, F)\big] = \mu' (1 - \mu')\rho'.
\end{equation}

Again, if $\rho' = 0$, then $p(s, F) = 1 - \mu'$.

\section[Mapping]{Mapping between $F$ and $F'$}

Given that the probability of failure in the next layer is $p(s, F) \sim \Beta(f', \rho')$, the distribution of functioning firms 

\begin{equation}
    F' \sim \Bin(m, p(s, F)) \equiv \Beta\Bin(m, 1 - \mu', \rho').
\end{equation}

This formulation allows as to write, through $p(s, F)$, the mapping between the parameters of $F$ and $F'$

\begin{equation}
    \begin{pmatrix}
        \mu' \\ \rho'
    \end{pmatrix} =: \begin{pmatrix}
        G_\mu(\mu, \rho, s) \\ G_\rho(\mu, \rho, s)
    \end{pmatrix} =: G(\mu, \rho, s).
\end{equation}

\subsection[Mean mapping]{Risk mapping, $G_\mu$}

We can derive analytically the mapping $\mu' = G_\mu(\mu, \rho, s)$. In particular

\begin{equation}
    \mu' = 1 - \E\big[p(s, F)\big] = \frac{\E\big[(m - F)_s\big]}{(m)_s}.
\end{equation}

Notice that $F \sim \Beta\Bin(m, 1 - \mu, \rho)$ implies \begin{equation}(m - F) \sim \Beta\Bin(m, \mu, \rho).\end{equation}

Then $\E\big[(m - F)_s\big]$ is the factorial moment of a beta-binomial distribution that has a known analytical form

\begin{equation}
    \E\big[(m - F)_s\big] = (m)_s \frac{B\Big( \mu \frac{1 - \rho}{\rho} + s, (1 - \mu)\frac{1 - \rho}{\rho} \Big)}{B\Big( \mu \frac{1 - \rho}{\rho}, (1 - \mu)\frac{1 - \rho}{\rho} \Big)}
\end{equation}

such that

\begin{equation}
    G_\mu(\mu, \rho, s) = \frac{B\Big( \mu \frac{1 - \rho}{\rho} + s, (1 - \mu) \frac{1 - \rho}{\rho} \Big)}{B\Big( \mu \frac{1 - \rho}{\rho}, (1 - \mu) \frac{1 - \rho}{\rho} \Big)}.
\end{equation}

where $B(x, y)$ is the beta function.

\begin{figure}[H]
    \centering
    \begin{subfigure}{.5\textwidth}
        \centering
        \includegraphics[width=\linewidth]{../plots/gf_small.pdf} 
        \caption{With $s = 1$}
        \label{fig:gf:small}  
    \end{subfigure}%
    \begin{subfigure}{.5\textwidth}
        \centering
        \includegraphics[width=\linewidth]{../plots/gf_large.pdf}       
        \caption{With $s = 20$}
        \label{fig:gf:large}
    \end{subfigure}
    \caption{Contour plot of $G_f - f$}
    \label{fig:gf}
\end{figure}

Again, by rewriting

\begin{equation} \label{eq:limit_Gmu}
    G_\mu(\mu, \rho, s) = \frac{\Big( \mu \  \frac{1 - \rho}{\rho} \Big)_s}{\Big( \frac{1 - \rho}{\rho} \Big)_s} = \frac{\mu^s \left(\frac{1 - \rho}{\rho}\right)^s + o\left(\left(\frac{1 - \rho}{\rho}\right)^{s - 1} \right) }{\left(\frac{1 - \rho}{\rho}\right)^s + o\left(\left(\frac{1 - \rho}{\rho}\right)^{s - 1} \right)}
\end{equation}

we can see that

\begin{equation}
    \lim_{\rho \rightarrow 0} G_\mu(f, \rho, s) = \mu^s
\end{equation}

which is the limit case we expect if there is no correlation among suppliers and, hence, $F$ follows a binomial distribution.

\subsection[Overdispersion mapping]{Overdispersion mapping, $G_\rho$}

Unfortunately, we are not as lucky with the mapping for $\rho' = G_{\rho}(\mu, \rho, s)$. The first link we can make is using the definition of $\V[p(s, F)]$ to see that

\begin{equation}
    \rho' = \frac{\V[p(s, F)]}{\mu' \ (1 - \mu')}.
\end{equation}

where

\begin{equation}
    \V[p(s, F)] = \E[p(s, F)^2] - \underbrace{\E[p(s, F)]^2}_{\left(1 - \mu'\right)^2}.
\end{equation}

Using the definition of $p$ we can write

\begin{equation}
    \begin{split}
        \E\big[ p(s, F)^2 \big] &= \E\left[1 - 2 \frac{(m - F)_s}{(m)_s} + \left(\frac{(m - F)_s}{(m)_s}  \right)^2\right] \\
        &= 1 - 2 \ \mu^\prime + \E\left[ \left(\frac{(m - F)_s}{(m)_s}  \right)^2 \right].
    \end{split}
\end{equation}

\subsubsection[Solution for m sufficiently large]{Solution for $m$ sufficiently large}

Let $R_m = F / m$. Then we can write $p$ as

\begin{equation}
    p(s, R_m) = 1 - \frac{(m(1- R_m))_s}{(m)_s}
\end{equation}

such that

\begin{equation}
   \E \left[p(s, R_m)^2\right] = 1 - 2 \ \mu' + \E\left[\left(\frac{(m(1- R_m))_s}{(m)_s} \right)^2\right].
\end{equation}

Consider the last term

\begin{equation}
    \begin{split}
        \E\left[\left(\frac{(m(1- R_m))_s}{(m)_s} \right)^2\right] &= \E\left[ \frac{m^2 (1 - R_m)^2 (m (1 - R_m) - 1)^2 \ldots (m(1-R_m) - s + 1)^2}{m^2 (m - 1)^2 \ldots (m - s + 1)^2} \right] \\
        &= \E\left[\frac{m^{2s}(1- R_m)^{2s} + o(m^{2s - 1})}{m^{2s} + o(m^{2s - 1})}\right] \xrightarrow{m \rightarrow \infty} \E\Big[ (1 - R)^{2s} \Big]
    \end{split}
\end{equation}

where $R = \lim_{m \rightarrow \infty} R_m$. We can now look at the distribution of $R$. I will make a claim motivated by a simulation (see Figure \ref{fig:rdist}).


\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{../plots/rlimit.pdf} 
    \caption{Simulated c.d.f. of $r$ and $\Bin$ with same parameters at $F$.}
    \label{fig:rdist}    
\end{figure}

\begin{claim}
    If $F \sim \Beta\Bin(m, \alpha, \beta)$ then $\lim_{m \rightarrow \infty} F / m \eqqcolon R \sim \Beta(\alpha, \beta)$.
\end{claim}

\begin{proof}

    The idea of the proof is to show that the moment generating function of $R_m$ converges pointwise to that of a beta distribution. This implies that the sequence $R_m$ converges in distribution to a beta, since the latter is determined by its moments (Theorem 30.2 in \cite{billingsley_probability_1995}). The moment generating function of $R_m$ can be written in terms of that of $F$ (\ref{eq:mgf_betabinomial}) as 

    \begin{equation} \label{eq:mgf_rm}
        \begin{split}
            M_{R_m}(t) &= \E\left[e^{t R_m}\right] \\ 
            &= \E\left[e^{(t / m) F}\right] = M_F(t / m) \\
            &= \prescript{}{2}{F}_1(-m, \alpha, \alpha + \beta; 1 - e^{t / m}). 
        \end{split}
    \end{equation}

    We seek to prove that this converges pointwise to 

    \begin{equation}
        M_R(t) = \prescript{}{1}{F}_1(\alpha, \alpha + \beta, t).
    \end{equation}

    Consider the Taylor series of 

    \begin{equation}
        1 - e^{t / m} = -\frac{t}{m} - \sum^{\infty}_{k = 2} \frac{t^k}{m^k \ k!}.
    \end{equation}

    This and the fact that $\prescript{}{2}{F}_1$ is continuous in $\abs{t} < m$, allows us to write

    \begin{equation}
        \begin{split}
            \lim_{m \rightarrow \infty} M_{R_m}(t) &= \lim_{m \rightarrow \infty} \prescript{}{2}{F}_1(-m, \alpha, \alpha + \beta; 1 - e^{t / m})\\
            &= \lim_{m \rightarrow \infty} \prescript{}{2}{F}_1(-m, \alpha, \alpha + \beta; - t/ m) \\
            &= \lim_{m \rightarrow \infty}\sum^{\infty}_{n=0} \frac{\alpha^{(n)}}{(\alpha + \beta)^{(n)}} t^n \  \frac{(-m)^{(n)}}{(-m)^n}.
        \end{split}
    \end{equation}

    
    Consider the last term in the summand 

    \begin{equation}
        \begin{split}
            \frac{(-m)^{(n)}}{(-m)^n} &= \frac{(-m)(-m + 1)(-m + 2)\ldots(-m + n - 1)}{(-1)^n m^n} \\
            &= \frac{(-1)^n m^n + o((-m)^{m - 1})}{(-1)^n m^n} \xrightarrow{m\rightarrow \infty} 1.
        \end{split}
    \end{equation}

    Hence 

    \begin{equation}
        \lim_{m \rightarrow \infty} M_{R_m}(t) = \lim_{m \rightarrow \infty}\sum^{\infty}_{n=0} \frac{\alpha^{(n)}}{(\alpha + \beta)^{(n)}} t^n \  \frac{(-m)^{(n)}}{(-m)^n} = \sum^{\infty}_{n=0} \frac{\alpha^{(n)}}{(\alpha + \beta)^{(n)}} t^n = M_R(t)
    \end{equation}

    such that $R_m \xrightarrow{d} R$.

\end{proof}

Given $R \sim \Beta(\alpha, \beta)$, such that $(1 - R) \sim \Beta(\beta, \alpha)$, we can write the $2s$-th moment of $1 - R$ as 

\begin{equation}
    \E[(1 - R)^{2s}] =  \left.\frac{\text{d}^{2s} M_{1 - R}}{\text{d}t^{2s}}\right\rvert_{t = 0} 
\end{equation}

hence, for large $m$,

\begin{equation}
    \begin{split}
        \E \left[p(s, R_m)^2\right] &\eqsim 1 - 2 \ \mu' + \left.\frac{\text{d}^{2s} \prescript{}{1}{F}_1}{\text{d}t^{2s}} \right\rvert_{(\beta, \alpha + \beta, 0)} \\
        &= 1 - 2 \ \mu' + \frac{\beta(\beta + 1)\ldots(\beta + 2s - 1)}{(\alpha + \beta)(\alpha + \beta + 1) \ldots (\alpha + \beta + 2s - 1)} \\
        \text{re-parametrising, } 
        &= 1 - 2 \ \mu' + B\left(\frac{1 - \rho}{\rho}, 2s \right) \Big/ B\left(\mu \ \frac{1 - \rho}{\rho}, 2s \right)
    \end{split}
\end{equation}

where we have used $\frac{\text{d}}{\text{d}t} \prescript{}{1}{F}_1(a; b; t) = \frac{a}{b} \prescript{}{1}{F}_1(a + 1; b + 1; t)$ and $\prescript{}{1}{F}_1(\cdot, \cdot, 0) = 1$. This implies that, for large $m$ and letting $\mu' = G_\mu(\mu, \rho, s)$, we can write our mapping $G_{\rho}$


\begin{equation}
    G_{\rho}(\mu, \rho, s) = \frac{ B\left(\frac{1 - \rho}{\rho}, 2s \right) \Big/ B\left(\mu \frac{1 - \rho}{\rho}, 2s \right)}{\mu' (1 - \mu')} - \frac{\mu'}{1 - \mu'}
\end{equation}

As a sanity check, we can do the same exercises as above (\ref{eq:limit_Gmu}) and compute the limit as $\rho \rightarrow 0$. We know already that $\lim_{\rho \rightarrow 0} \mu' = \mu^s$. We are left to compute

\begin{equation}
    \lim_{\rho \rightarrow 0} \frac{B\left(\frac{1 - \rho}{\rho}, 2s \right)}{B\left(\mu \frac{1 - \rho}{\rho}, 2s \right)} = \lim_{\rho \rightarrow 0} \frac{\left(\mu \frac{1 - \rho}{\rho} + 2s\right)_{2s}}{\left(\frac{1 - \rho}{\rho} + 2s\right)_{2s}} = \mu^{2s}.
\end{equation}

Then, as expected

\begin{equation}
    \lim_{\rho \rightarrow 0} G_{\rho}(f, \rho, s) = \frac{\mu^{2s}}{\mu^s \big(1 - \mu^s\big)} - \frac{\mu^s}{\big(1 - \mu^s\big)} = 0.
\end{equation}

So, if there is no correlation among suppliers and $F \sim \Bin$, there will be no correlation downstream and $F' \sim \Bin$.

\begin{figure}[H]
    \centering
    \begin{subfigure}{.5\textwidth}
      \centering
      \includegraphics[width=\linewidth]{../plots/grho_small.pdf} 
      \caption{With $s = 1$}
      \label{fig:grho:small}  
    \end{subfigure}%
    \begin{subfigure}{.5\textwidth}
      \centering
      \includegraphics[width=\linewidth]{../plots/grho_large.pdf}       
      \caption{With $s = 5$}
      \label{fig:grho:large}
    \end{subfigure}
    \caption{Contour plot of $G_\rho - \rho$}
    \label{fig:grho}
  \end{figure}

\iffalse

\subsection[Derivatives of map]{Derivatives of $G$}

\begin{equation}
    \frac{\partial G_f}{\partial f} = \big(1 - G_f\big) \ \frac{1 - \rho}{\rho} \left(
        \psi ^{(0)}\left((1 - f)\frac{1- \rho}{\rho} + s\right) -
        \psi ^{(0)}\left((1 - f)\frac{1- \rho}{\rho}\right)\right)
\end{equation}

\begin{equation}
    \begin{split}
        \frac{\partial G_f}{\partial \rho} = \frac{1 - G_f}{\rho^2} \Bigg[ (1-f)&\left[
            \psi ^{(0)}\left((1 - f)\frac{1- \rho}{\rho} + s\right) -
            \psi ^{(0)}\left((1 - f)\frac{1- \rho}{\rho}\right)\right] - \\
            &\left[
                \psi ^{(0)}\left(\frac{1- \rho}{\rho} + s\right) -
                \psi ^{(0)}\left(\frac{1- \rho}{\rho}\right)\right]
            \Bigg]
    \end{split}
\end{equation}

\fi

% --- Bibliography
\newpage
\printbibliography

\end{document}