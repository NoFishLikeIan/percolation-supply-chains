\documentclass[american, abstract=on]{scrartcl}

    \newcommand{\lang}{en}

    \usepackage{babel}
    \usepackage[utf8]{inputenc}

    \usepackage{csquotes}

    \usepackage{amsmath, amssymb, mathtools, bbm}
    \usepackage{xcolor}
    \usepackage{xcolor-solarized}
    \usepackage{bm}

    \usepackage{graphicx}
    \usepackage{wrapfig}
    \usepackage{relsize}
    \usepackage{makecell}
    \usepackage{booktabs}
    \usepackage[font=footnotesize,labelfont=bf]{caption}
    \usepackage{subcaption}
    \usepackage{float}
    \usepackage{multirow} 
    
    % Formatting
    \setlength{\parindent}{0em}
    \setlength{\parskip}{0.5em}
    \setlength{\fboxsep}{1em}
    \newcommand\headercell[1]{\smash[b]{\begin{tabular}[t]{@{}c@{}} #1 \end{tabular}}}

    % Graphs

    % Math commands

    \newcommand{\diff}{\text{d}}
    \renewcommand{\Re}{\mathbb{R}}
    \newcommand{\C}{\mathcal{C}}
    \newcommand{\F}{\mathcal{F}}
    \newcommand{\X}{\mathcal{X}}
    \newcommand{\G}{\mathcal{G}}
    \newcommand{\I}{\mathcal{I}}
    \newcommand{\N}{\mathcal{N}}
    \newcommand{\PF}{\mathcal{P} \F}

    \renewcommand{\P}{\mathbb{P}}
    \newcommand{\E}{\mathbb{E}}
    \newcommand{\V}{\mathbb{V}}

    \newcommand{\uI}[2][s]{\int^1_0 #2 \ \text{d} #1}
    \newcommand{\uH}[2][s]{\int^\frac{1}{2}_0 #2 \ \text{d} #1}
    \newcommand{\uF}[2][s]{\int^1_\frac{1}{2} #2 \ \text{d} #1}
    \newcommand{\norm}[1]{\left\lVert#1\right\rVert}
    \newcommand{\abs}[1]{\left\lvert#1\right\rvert}

    \newcommand{\Beta}{\text{Beta}}
    \newcommand{\Bin}{\text{Bin}}

    % Make title page

    \author{Andrea Titton}
    \title{Derivation of mapping}

    \setcounter{section}{-1}  % Start numbering at 0
    
\begin{document}

\maketitle

\section{Notation}

\begin{enumerate}
    \item For some integer $m$, let $[m] \coloneqq \{0, 1, \ldots, m\}$.
    \item For two numbers $x, s$ let the falling factorial of $x$ to $s$ be \begin{equation}
        (x)_s \coloneqq \begin{cases} x(x - 1)(x - 2)\ldots(x - (s - 1)) & \text{if } s \in \mathbb{N}_0 \\
       \Gamma(1 + x) \Big/ \Gamma(1 + x - s)& \text{if } s \in \Re^{+}
        \end{cases}
    \end{equation}.
\end{enumerate}

\section{Problem statement}

Define $F \in [m]$ to be the number of functioning firm in the suppliers layer and assume 

\begin{equation}
    F \sim \Beta\Bin(m, f, \rho)
\end{equation}

with $m \in \mathbb{N}_0$ and $f, \rho \in [0, 1]$.

\subsection{Notes on the beta-binomial distribution}

\begin{enumerate}
    \item Usually, the beta-binomial is parametrized with two parameters $\alpha$ and $\beta$. Here I choose $f$ and $\rho$ instead, which provide a better interpretation for the problem at hand. The two parametrizations can be linked by taking \begin{equation}
        \rho = \frac{1}{\alpha + \beta + 1} \text{ and } f = \frac{\alpha}{\alpha + \beta}.
    \end{equation}
    \item The beta binomial can be seen as a compounded random variable, generated by taking a binomial distribution $F \sim \Bin(m, p)$ with probability of success $p \sim \Beta(\alpha, \beta)$.
    \item The first two moments of the beta-binomial distribution can be written as \begin{equation}
        \E[F] = m f \text{ and } \V[F] = m f (1 - f) (1 + (m - 1) \rho).
    \end{equation} If $\rho = 0$, the beta-binomial degenerates into a binomial distribution, hence $\rho$ can be interpreted as an ``overdispersion'' vis-Ã -vis the binomial distribution.
\end{enumerate}

\subsection{The next layer probability}

Let $p$ be the function that maps the number of functioning firms in the suppliers layer and the number of chosen suppliers to the probability of a firm being functional in a given layer. In particular, $p: [0, m] \times \{0, 1, 2, \ldots m\} \to [0, 1]$ can be written equivalently

\begin{equation}
    p(s, F) = 1 - \binom{m - s}{F} \binom{m}{F}^{-1} = 1 - \frac{(m - F)_s}{(m)_s}
\end{equation}

Hereafter I will fit, by moments matching,

\begin{equation}
    p(s, F) \ \dot{\sim} \ \Beta(f', \rho').
\end{equation}

Motivated by simulated results (see \ref{fig:pfit}), I believe this to be not an approximation but the true distribution of $p(s, F)$. 

\begin{figure}[H]
    \centering
    \includegraphics[width = 0.8\linewidth]{../plots/pfit.png}
    \caption{Cumulative density function of $p(s, F)$ (line) and the fitted $\Beta$ distribution (scatter).}
    \label{fig:pfit}
\end{figure}

We parametrised $p(s, F)$ with $(f', \rho')$, which have the same interpretation as in $F$. In particular,

\begin{equation}
    \E\big[p(s, F)\big] = f' \text{ and } \V\big[p(s, F)\big] = f' (1 - f')\rho'.
\end{equation}

Again, if $\rho' = 0$, then $p(s, F) = f'$.

\subsection{Mapping between $F$ and $F'$}

Given that the probability of failure in the next layer is $p(s, F) \sim \Beta(f', \rho')$, the distribution of functioning firms 

\begin{equation}
    F' \sim \Bin(m, p(s, F)) \equiv \Beta\Bin(m, f', \rho').
\end{equation}

This formulation allows as to write, through $p(s, F)$, the mapping between the parameters of $F$ and $F'$

\begin{equation}
    \begin{pmatrix}
        f' \\ \rho'
    \end{pmatrix} =: \begin{pmatrix}
        G_f(f, \rho, s) \\ G_\rho(f, \rho, s)
    \end{pmatrix} =: G(f, \rho, s).
\end{equation}

\subsubsection{The mean mapping, $G_f$}

We can derive analytically the mapping $f' = G_f(f, \rho, s)$. In particular

\begin{equation}
    f' = \E\big[p(s, F)\big] = 1 - \frac{\E\big[(m - F)_s\big]}{(m)_s}.
\end{equation}

Notice that $F \sim \Beta\Bin(m, f, \rho)$ implies \begin{equation}(m - F) \sim \Beta\Bin(m, 1 - f, \rho).\end{equation}

Then $\E\big[(m - F)_s\big]$ is the factorial moment of a beta-binomial distribution that has a known analytical form

\begin{equation}
    \E\big[(m - F)_s\big] = (m)_s \frac{B\Big( (1 - f) \frac{1 - \rho}{\rho} + s, f \frac{1 - \rho}{\rho} \Big)}{B\Big( (1 - f) \frac{1 - \rho}{\rho}, f \frac{1 - \rho}{\rho} \Big)}
\end{equation}

such that

\begin{equation}
    G_f(f, \rho, s) = 1 - \frac{B\Big( (1 - f) \frac{1 - \rho}{\rho} + s, f \frac{1 - \rho}{\rho} \Big)}{B\Big( (1 - f) \frac{1 - \rho}{\rho}, f \frac{1 - \rho}{\rho} \Big)}.
\end{equation}

where $B(x, y)$ is the beta function.

\begin{figure}[H]
    \centering
    \begin{subfigure}{.5\textwidth}
      \centering
      \includegraphics[width=\linewidth]{../plots/gf_small} 
      \caption{With $s = 1$}
      \label{fig:gf:small}  
    \end{subfigure}%
    \begin{subfigure}{.5\textwidth}
      \centering
      \includegraphics[width=\linewidth]{../plots/gf_large}       
      \caption{With $s = 20$}
      \label{fig:gf:large}
    \end{subfigure}
    \caption{Contour plot of $G_f$}
    \label{fig:gf}
  \end{figure}

Again, by rewriting

\begin{equation}
    G_f(f, \rho, s) = 1 - \frac{\Big( (1-f) \frac{1 - \rho}{\rho} \Big)_s}{\Big( \frac{1 - \rho}{\rho} \Big)_s} = 1 - \frac{(1 - f)^s \left(\frac{1 - \rho}{\rho}\right)^s + o\left(\left(\frac{1 - \rho}{\rho}\right)^{s - 1} \right) }{\left(\frac{1 - \rho}{\rho}\right)^s + o\left(\left(\frac{1 - \rho}{\rho}\right)^{s - 1} \right)}
\end{equation}

we can see that

\begin{equation}
    \lim_{\rho \rightarrow 0} G_f(f, \rho, s) = 1 - (1 - f)^s
\end{equation}

which is the limit case we expect if there is no correlation among suppliers and, hence, $F$ follows a binomial distribution.

\subsubsection{The overdispesion mapping, $G_\rho$}

Unfortunately, we are not as lucky with the mapping for $\rho' = G_{\rho}(f, \rho, s)$. The first link we can make is using the definition of $\V[p(s, F)]$ to see that

\begin{equation}
    \rho' = \frac{\V[p(s, F)]}{f' \ (1 - f')}.
\end{equation}

where

\begin{equation}
    \V[p(s, F)] = \E[p(s, F)^2] - \underbrace{\E[p(s, F)]^2}_{\left(f'\right)^2}.
\end{equation}

Using the definition of $p$ we can write

\begin{equation}
    \begin{split}
        \E\big[ p(s, F)^2 \big] &= \E\left[1 - 2 \frac{(m - F)_s}{(m)_s} + \left(\frac{(m - F)_s}{(m)_s}  \right)^2\right] \\
        &= 1 - 2(1 - f') + \E\left[ \left(\frac{(m - F)_s}{(m)_s}  \right)^2 \right].
    \end{split}
\end{equation}

\subsubsection{Attempting a ratio}

Let $r = F / m$. Then we can write compactly $p$ as

\begin{equation}
    p(s, r) = 1 - \frac{(m(1- r))_s}{(m)_s}
\end{equation}

such that

\begin{equation}
   \lim_{m \rightarrow \infty} \E \left[p(s, r)^2\right] = 1 - 2(1 - f') + \E\left[(1 - r)^{2s}\right].
\end{equation}

\end{document}