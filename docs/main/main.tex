\documentclass[american, abstract=on]{scrartcl}

    \newcommand{\lang}{en}

    \usepackage{babel}
    \usepackage[utf8]{inputenc}

    \usepackage{csquotes}

    \usepackage{amsmath, amssymb, mathtools, bbm}
    \usepackage{amsthm}
    \usepackage{xcolor}
    \usepackage{xcolor-solarized}
    \usepackage{bm}

    \usepackage{graphicx}
    \usepackage{wrapfig}
    \usepackage{relsize}
    \usepackage{makecell}
    \usepackage{booktabs}
    \usepackage[font=footnotesize,labelfont=bf]{caption}
    \usepackage{subcaption}
    \usepackage{float}
    \usepackage{multirow} 
    \usepackage{hyperref}
    \usepackage{bookmark}
    
    % Diagrams
    \usepackage{tikz} 
    \usepackage{tikzit}
    \usetikzlibrary{positioning,fit,calc,decorations.pathreplacing,calligraphy}
    \input{../diagrams/percolation.tikzstyles}
    \input{../diagrams/diagram.tikzstyles}
    \input{../diagrams/custom.tikzstyles}

    \newcommand{\inputTikZ}[2]{%  
        \IfFileExists{#2}{
          \scalebox{#1}{\input{#2}}  
      }{
        \includegraphics[width=0.5\textwidth]{example-image-a}
      }
    }
    
    % Refs
    \usepackage{hyperref}
    \usepackage{cleveref}
    \hypersetup{
        colorlinks = true, 
        urlcolor = blue,
        linkcolor = blue, 
        citecolor = blue 
      }      

    \usepackage{subfiles} % Load last

    % Theorems
    \theoremstyle{plain}
    \newtheorem{lemma}{Lemma}
    \newtheorem{definition}{Definition}
    \newtheorem{theorem}{Theorem}

    % Paths

    % Formatting
    \setlength{\parindent}{0em}
    \setlength{\parskip}{0.5em}
    \setlength{\fboxsep}{1em}
    \newcommand\headercell[1]{\smash[b]{\begin{tabular}[t]{@{}c@{}} #1 \end{tabular}}}

    % Graphs

    % Math commands

    \newcommand{\diff}{\text{d}}
    \renewcommand{\Re}{\mathbb{R}}
    \newcommand{\C}{\mathcal{C}}
    \newcommand{\F}{\mathcal{F}}
    \newcommand{\X}{\mathcal{X}}
    \newcommand{\G}{\mathcal{G}}
    \newcommand{\I}{\mathcal{I}}
    \newcommand{\N}{\mathcal{N}}
    \newcommand{\PF}{\mathcal{P} \F}

    \renewcommand{\P}{\mathbb{P}}
    \newcommand{\E}{\mathbb{E}}
    \newcommand{\V}{\mathbb{V}}

    \newcommand{\uI}[2][s]{\int^1_0 #2 \ \text{d} #1}
    \newcommand{\uH}[2][s]{\int^\frac{1}{2}_0 #2 \ \text{d} #1}
    \newcommand{\uF}[2][s]{\int^1_\frac{1}{2} #2 \ \text{d} #1}
    \newcommand{\norm}[1]{\left\lVert#1\right\rVert}
    \newcommand{\abs}[1]{\left\lvert#1\right\rvert}

    \newcommand{\Beta}{\text{Beta}}
    \newcommand{\Bin}{\text{Bin}}

    % Bibliography

    \usepackage[bibencoding=utf8, style=apa, backend=biber]{biblatex}
    \addbibresource{../supply-chain-reallocation.bib}

    \newcommand{\citein}[1]{\citeauthor{#1} (\citeyear{#1})}

    \newcommand\notes[1]{\textcolor{teal}{\textbf{#1}}}
    \newcommand\red[1]{\textcolor{red}{#1}}

    % Make title page

    \author{Andrea Titton}
    \title{Firms' Sourcing Decisions and\\ Production Network Fragility}
    
\begin{document}

\maketitle
\section{Introduction}

\section{Model}

In this section I will introduce a stylised production game of suppliers' risk diversification, in the spirit of the one developed by \citein{elliott_supply_2022}. The model, despite its simplicity, captures the interactions between firms’ decisions and suppliers’ correlation risks. I show how the correlation in suppliers’ risk, on top of directly introducing substantial tail risk, disincentivises firm risk diversification, even when the firms are risk neutral. Strikingly, the interaction between suppliers’ risk correlation and firms’ decision, can introduce fragility in a production network even if risk is kept constant.

\subsection{Setup}

Consider a vertical economy producing $K$ goods (as displayed in Figure \ref{fig:vertical-economy-diagram}). Each firm produces a single good and each good is produced by $m$ firms. The good produced in layer $k$ requires only the good produced in layer $k - 1$ as input. Each firm picks a set of suppliers in the previous layer to source from. Establishing a relation with a supplier has a fixed cost $\kappa$. If no firm, among its suppliers, is able to deliver the input good then the firm is not ``functional'' and hence not able to deliver downstream. I assume that being functional yields an exogenous payoff $\pi$. This assumption will be relaxed later by introducing market structure to endogenise $\pi$, but this does not change the main model mechanics. Finally, we assume that firms know the structure of the economy but do not observe the realised supplier relationship in upstream layers. The only source of risk in the model is a idiosyncratic probability $\mu$ that firms in layer $0$, which require no inputs, are not able to carry on production.

\begin{figure}[H]
  \centering
  \inputTikZ{0.5}{../diagrams/model-presentation.tikz} 
  \caption{$K$-layers vertical economy}
  \label{fig:vertical-economy-diagram}
\end{figure}

Letting $p_{k, i}$ be the probability of firm $i$ in layer $k$ being functional, the expected payoff for each firm is then

\begin{equation}
  \pi \times p_{k, i}(\text{suppliers of }i) - \kappa \times \text{number of suppliers of }i.
\end{equation}

\subsection{Firm Problem}

We assume here that the firm cannot observe the realisation of supplier relationships. This introduces a symmetric component into the firms' problem, namely, when faced with their supplier decision, it is sufficient for a firm to track the distribution of risk among suppliers and then pick the optimal number of sources at random. Furthermore, this choice will be identical for all firms producing a good, since they are ex-ante equal. Let $s_k$ be the number of suppliers picked by the repesentative firm in layer $k$ and $F_k$ be the distribution of functioning firms producing good $k$. Then, if a firm producing good $k + 1$ were to pick $s_{k + 1}$ suppliers among those producing $k$, the probability that not all of its suppliers are functional, $p_m : [m] \times [m] \to \mathbb{Q} \cap [0, 1]$, is

\begin{equation}
  p_m(s_{k + 1}, F_k) \coloneqq 1 - \overbrace{\binom{m - s_{k+1}}{F_k}}^{\substack{\text{sets of functioning firms such} \\ \text{that none are suppliers}}} \Bigg/ \underbrace{\binom{m}{F_k}}_{\substack{\text{all possible sets} \\ \text{of functioning firms}}}.
\end{equation}

\begin{definition} \label{definition:ptoF}
  If $p_k \sim \Beta(1 - \mu_k, \rho_k)$ then $F_k \coloneqq \Bin\big(m, p_k \big)$ follows a $\Beta\Bin(m, 1 - \mu_k, \rho_k)$, with,

  \begin{equation} \label{eq:moments_of_F}
    \E \big[F_k\big] = m \ \E \big[p\big] = m \ (1 - \mu_k) \text{ and } \V \big[F_k\big] = m \ \mu_k \ (1 - \mu_k) \big(1 + (m - 1) \ \rho_k\big)
  \end{equation}

  Notice that $F_k$ inherits its parameters from $p_k$.
\end{definition}

\begin{lemma} \label{lemma:Ftop}
  If $F_k$ is a r.v. taking values in $[m]$, then \begin{equation*}\lim_{m \rightarrow \infty} p_m(s_{k + 1}, F_k) \eqqcolon p_k \sim \Beta(1 - \mu_{k + 1}, \rho_{k + 1})\end{equation*} for some $\mu_{k + 1}$ and $\rho_{k + 1}$.
\end{lemma}

The proof of this lemma {\color{red} is not done yet.} Lemma \ref*{lemma:Ftop} and Definition \ref*{definition:ptoF} combine into a powerful result: for large enough $m$ the number of firms that are able to operate at each stage of the production networks, $\{F_k\}$, follow the same distribution. Such distributions are fully determined by the initial one, $F_0$, and the choices of suppliers in each layer, $\{s_k\}$. Furthermore, for the agent to solve its maximisation problem, hence pick a number of suppliers $s_k$, it is sufficient to infer the distribution of functioning firms among its suppliers, $F_{k - 1}$. As illustrated in Figure \ref*{fig:propagation-of-risk}, this implies that we can simply keep track of evolution of the two parameters $\mu_k$ and $\rho_k$.


\begin{figure}[H]
  \centering
  \inputTikZ{0.7}{../diagrams/probability-propagation.tikz} 
  \caption{Diagram of the relation between $F_k$, $p_k$, and $F_{k - 1}$, for sufficiently large $m$.}
  \label{fig:propagation-of-risk}
\end{figure}

\subsubsection{Interpretation of the Parameters}

It is useful at this point to give an interpretation of $\mu$ and $\rho$, in the context of our model. Looking back at the relationship between the moments of $F_k$ and these parameters (Equation \ref{eq:moments_of_F}), we can see that $\mu_k$ is the fraction of firms that are expected to not deliver in layer $k$. A more subtle role is played by $\rho_k$. If $\rho_k = 0$, then there is no dispersion on the probability of failure and $F_k$ follows a binomial distribution. In this sense, we can use $\rho_k$ as a measure of suppliers' correlation in the system: if all firms have different suppliers, then $\rho_k = 0$ and the probability of failure is constant for all firms producing a given good, hence, the number of firms failing follows a binomial distribution. Hereafter, I will refer to $\mu_k$ as \textit{risk} and $\rho_k$ as \textit{overdispersion}.

\subsubsection{Dynamics of Risk}

Let $G$ be the function mapping the risk and overdispersion between layers. As we have argued above, the downstream risk and overdispersion depend only that of the suppliers' and on the number of suppliers chosen by the representative firm in the current layer,

\begin{equation}
  \begin{pmatrix}
    \mu_{k + 1} \\ \rho_{k + 1}
  \end{pmatrix} =  \begin{pmatrix}
    G_{\mu}(\mu_k, \rho_k; s_{k + 1}) \\ G_{\rho}(\mu_k, \rho_k; s_{k + 1})
  \end{pmatrix} = G(\mu_k, \rho_k; s_{k + 1}).
\end{equation}

Deriving the evolution of risk, $\mu$, (see Appendix \ref{appendix:derivations}), if the number of suppliers is restricted to be a positive integer, yields

\begin{equation} \label{eq:G_mu}
  G_\mu(\mu, \rho, s) = \frac{\left( \mu \  \frac{1 - \rho}{\rho} \right)^{(s)}}{\left( \frac{1 - \rho}{\rho} \right)^{(s)}} = \prod^{s - 1}_{n = 0} \frac{\mu + n \frac{\rho}{1 - \rho}}{1 + n \frac{\rho}{1 - \rho}}
\end{equation}

where $x^{(s)}$ is the rising factorial $x \ (x + 1) \ \ldots \ (x + s - 1)$. The expansion in equation (\ref{eq:G_mu}), highlights the effect of the suppliers' correlation in risk propagation. Namely, adding the $n$-th supplier reduces risk by a factor of 

\begin{equation}
  (1 - \mu) \ \frac{1}{1 + n \frac{\rho}{1 - \rho}}.
\end{equation}

As more suppliers are added, $n$, or correlation increases, $\rho$, the marginal reduction in risk the firm can expect from adding a supplier decreases. This expansion also shows how this dynamical system can be seen as a generalisation of the simpler dynamical system where there is no correlation in the supplier risk, such that

\begin{equation}
  \lim_{\rho \rightarrow 0} G_\mu(\mu, \rho, s) = \mu^s.
\end{equation}

Similarly, for sufficiently large $m$, we can derive an analytical expression for the evolution of overdisperion. Letting $\mu' = G_\mu(\mu, \rho, s)$, then

\begin{equation}
  G_\rho(\mu, \rho, s) = \frac{\left( \mu \  \frac{1 - \rho}{\rho} + s \right)^{(s)} \Big/ \left( \frac{1 - \rho}{\rho} + s \right)^{(s)} - \mu'}{1 - \mu'} = \frac{\prod^{s - 1}_{n = 0} \frac{\mu + (n + s) \frac{\rho}{1 - \rho}}{1 + (n + s) \frac{\rho}{1 - \rho}} - \mu'}{1 - \mu'}
\end{equation}



Again, without suppliers' correlation, the dynamical system converges to the simpler binomial case,

\begin{equation}
  \lim_{\rho \rightarrow 0} G_\rho(\mu, \rho, s) = 0.
\end{equation}

Another intuitive property of the dynamical system is that the risk and correlation are constant throughout the layers only if the choice of suppliers is $s = 1$. 

\begin{lemma}
  In $(\mu, \rho) \in (0, 1)^2$, if $s = 1$, every point is a fixed point \begin{equation}
    (\mu, \rho) = G(\mu, \rho, 1),  
  \end{equation} and if $s \neq 1$ there are no fixed points.
\end{lemma}

\subsubsection{Agent's Choice}

The representative agent in layer $k + 1$ choses the number of suppliers $s_{k+1}$ to maximise

\begin{equation}
  \pi \Big(1 - G_{\mu}(\mu_k, \rho_k, s_{k+1})\Big) - \kappa \  s_{k + 1}.
\end{equation}

It is instructive to solve the problem for $s \in \Re_{\geq 0}$, instead of $s \in \mathbb{Z}$. Let $\tilde{s}: [0, 1]^2 \to \Re$ be such that $s_{k + 1} = \tilde{s}(\mu_k, \rho_k)$ maximises the firm problem and $\tilde{G}(\mu, \rho) = G\big(\mu, \rho, \tilde{s}(\mu, \rho)\big)$. $\tilde{s}$ needs to satisfy the first order condition

\begin{equation}
  \begin{split}
    0 &= \frac{\kappa}{\pi} + \left. \frac{\partial G_\mu}{\partial s} \right\vert_{(\mu, \rho, \tilde{s})}  \\
    &= \frac{\kappa}{\pi \ G_\mu(\mu, \rho, \tilde{s})} + \psi_0\left(\tilde{s} + \mu \frac{1 - \rho}{\rho} \right) - \psi_0\left(\tilde{s} + \frac{1 - \rho}{\rho} \right)  
  \end{split}
\end{equation}

where $\psi_0$ is the digamma function.

\subsubsection{A Special Case: No Correlation Risk}

As correlation disappears, the function $G$ converges to its familiar binomial counterpart,

\begin{equation}
  \tilde{G}(\mu, 0) \coloneqq \lim_{\rho \rightarrow 0} \tilde{G}(\mu, \rho) = \begin{pmatrix} \mu^{\tilde{s}(\mu, 0)} \\ 0 \end{pmatrix}.
\end{equation}

Taking the limit of the derivative yields

\begin{equation}
  \lim_{\rho \rightarrow 0}\tilde{G}_\mu(\mu, \rho) \left(\psi_0\left(\tilde{s} + \mu \frac{1 - \rho}{\rho} \right) - \psi_0\left(\tilde{s} + \frac{1 - \rho}{\rho} \right) \right) = \mu^{\tilde{s}} \log(\mu) = \frac{\partial \tilde{G}_{\mu}(\mu, 0)}{\partial s}.
\end{equation}

Hence, using the first order condition we can show that

\begin{equation}
  \tilde{G}_{\mu}(\mu, 0) = -\frac{\kappa / \pi}{\log(\mu)}.
\end{equation}

\subsection{Social Planner}

The social planner problem consists in, on the one hand, minimising aggregate risk and, on the other, the number of edges. 

The risk faced by a firm depends only on how many firms in the first layer it is connected to, regardless of what path. Namely, if $n$ basal firms are involved in the firms' production, its risk is $1 - \mu^n$. Hence, a natural question is, if the social planner seeks to connect a firm to $n$ basal firms, what is the most edge parsimonious way to do so? 

\begin{definition}
  Let $\textit{min-max}(n)$ be the network where all firms in layer $1$ have $n$ suppliers and thereafter, each firm, is connect to only one supplier. 
\end{definition}

\begin{lemma}
  $\textit{min-max}(n)$ is the network with fewer edges that achieves $\mu^n$ risk.
\end{lemma}

\begin{proof}

To see this, consider Figure (\ref{fig:planner-n-target}). If the planner wants to achieve risk $\mu^n$ in layer $k$, any branching (right), vis-à-vis the min-max network (left), requires at a list one more edge to close the branching, hence it has as strictly more edges than the min-max network.

\end{proof}

\begin{figure}[H]
  \centering
  \begin{subfigure}{.5\textwidth}
    \centering
    \inputTikZ{0.5}{../diagrams/min-max-n.tikz} 
  \end{subfigure}%
  \begin{subfigure}{.5\textwidth}
    \centering
    \inputTikZ{0.5}{../diagrams/not-min-max-n.tikz} 
  \end{subfigure}%
  \caption{Blabla}
  \label{fig:planner-n-target}
\end{figure}

Furthermore, note that if a firm in layer $k$ is connected, the marginal benefit $\pi (1 - \mu^n)$ must be bigger than marginal costs $\kappa$, then it must be profitable to connect a firm in layer $k + 1$, since the marginal benefit would be the same.

Finally, the social planner will be the largest $n$ such that

\begin{equation}
  n < \frac{\log(\pi / \kappa) - \log(1 - \mu)}{\log(\mu)}.
\end{equation}

come stai
\newpage
\nocite{*}
% \printbibliography

\pagenumbering{gobble} % stop page numbering
\newpage
\appendix
\subfile{sections/appendix/appendix.tex}

\end{document}